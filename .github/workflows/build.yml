name: Android Build

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      - name: Sign APK manually
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ALIAS: ${{ secrets.ALIAS }}
        run: |
          # Create a directory for signed output
          mkdir -p signed_apk
          
          # Decode the Base64 keystore into a file
          echo $SIGNING_KEY | base64 -d > release.keystore
          
          # Find the Android Build Tools path
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          
          # Paths to the Unsigned and Signed APKs
          UNSIGNED_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
          ALIGNED_APK="signed_apk/app-release-aligned.apk"
          SIGNED_APK="signed_apk/app-release.apk"
          
          # Align the APK using zipalign
          $BUILD_TOOLS_DIR/zipalign -v -p 4 $UNSIGNED_APK $ALIGNED_APK
          
          # Sign the aligned APK using apksigner
          $BUILD_TOOLS_DIR/apksigner sign --ks release.keystore \
            --ks-key-alias $ALIAS \
            --ks-pass pass:$KEY_STORE_PASSWORD \
            --key-pass pass:$KEY_PASSWORD \
            --out $SIGNED_APK $ALIGNED_APK

      - name: Create Release and Upload APK
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate a dynamic tag based on the commit hash and run number
          TAG_NAME="build-${{ github.run_number }}-$(git rev-parse --short HEAD)"
          RELEASE_NAME="Auto Build #${{ github.run_number }}"
          
          # Create a Release using GitHub CLI
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "Automated release triggered by push to master." \
            signed_apk/app-release.apk

